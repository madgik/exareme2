import numpy as np
import pytest
import statsmodels.api as sm

from exaflow.algorithms.federated.ols import FederatedOLS
from tests.standalone_tests.federated_algorithms.utils import DummyAggClient


def _run_and_compare(X_raw, y):
    X = sm.add_constant(X_raw, has_constant="add")
    y = np.asarray(y, dtype=float).reshape(-1, 1)

    agg_client = DummyAggClient()
    model = FederatedOLS(agg_client=agg_client)
    model.fit(X, y)

    sm_model = sm.OLS(y, X).fit()

    assert model.nobs == X.shape[0]
    assert np.allclose(model.params, sm_model.params, atol=1e-8)
    assert np.allclose(model.bse, sm_model.bse, atol=1e-8)
    assert np.allclose(model.tvalues, sm_model.tvalues, atol=1e-8)
    assert np.allclose(model.pvalues, sm_model.pvalues, atol=1e-8)
    assert np.isclose(model.rsquared, sm_model.rsquared, atol=1e-8)
    assert np.isclose(model.rsquared_adj, sm_model.rsquared_adj, atol=1e-8)
    assert np.isclose(model.fvalue, sm_model.fvalue, atol=1e-8)
    assert np.isclose(model.f_pvalue, sm_model.f_pvalue, atol=1e-8)
    assert np.isclose(model.df_resid, sm_model.df_resid, atol=1e-8)
    assert np.isclose(model.df_model, sm_model.df_model, atol=1e-8)


TEST_CASES = [
    (
        np.array(
            [
                [
                    0.45895710350893726,
                    -0.07986704886931975,
                    1.1071585929370238,
                    0.5687729648147273,
                ],
                [
                    1.1081295320547802,
                    -0.027708176198438905,
                    -0.5792216981075133,
                    0.24000076877476603,
                ],
                [
                    0.7351375011633077,
                    -1.5417231838457583,
                    1.5352167014390576,
                    2.8566710161536855,
                ],
                [
                    -0.45952560565399536,
                    -2.328420868044742,
                    0.88760633158547,
                    -0.6438594068270818,
                ],
                [
                    0.23832251145291244,
                    0.7389695796512584,
                    0.23323863106977613,
                    -0.6066720172020732,
                ],
                [
                    -1.0294348298015388,
                    -0.4024142796751995,
                    -0.13136881598846065,
                    0.749506250509607,
                ],
                [
                    0.34739539589786933,
                    -1.8900103818864806,
                    0.8201421400665005,
                    0.40957799517438437,
                ],
                [
                    1.0366850503738494,
                    0.9718939528494487,
                    0.6657134484687036,
                    -1.5950679699024193,
                ],
            ],
            dtype=float,
        ),
        np.array(
            [
                0.2338901831271875,
                1.1901310636443556,
                -4.665384282140217,
                -1.6320695601839048,
                3.2549488480728614,
                0.12549746984751253,
                -2.216048310310612,
                4.225407030723983,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [1.334062922639299, 0.13972552398947102, 0.184026613856656],
                [-1.2679016676682517, -0.5828006541341091, -0.19645567336472458],
                [-1.9668503562401813, -2.0217174608698434, -0.02532042091671448],
                [-1.6013842886474439, -0.5846829363480635, 1.120143261603186],
                [0.24522562076927906, -1.4439241674616135, -0.3526551403841781],
                [0.5189256249378157, -1.6977859109675086, -0.027439690217705016],
                [1.412727070633817, -1.3047370444429296, 1.7339321500708291],
                [-0.1258523633858579, 2.4139681720745387, 1.471337661372298],
                [-1.64159498102835, 0.641263515330452, 1.0910498926836534],
                [0.7064432626536774, 1.1806355721494308, -0.1186990600973958],
                [-1.6687418961500051, -0.8888247862324199, 0.2385499009925068],
            ],
            dtype=float,
        ),
        np.array(
            [
                -0.8580533647287553,
                4.950529772832982,
                8.347990465249481,
                2.4545767372137286,
                5.064510567265798,
                4.582888871764318,
                -1.2003283690835098,
                -6.773368793555548,
                0.04597324746271572,
                -1.6380199692437847,
                5.009538796263564,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [0.9474548359852455, -0.7349400026375501],
                [0.9264536247737701, 0.6481700390949381],
                [0.18932952091545294, 0.401911263910607],
                [-0.007856135137136722, 0.31564917323205705],
                [0.347182433259875, 1.44513426505179],
                [-1.442378408526198, 0.944539425911339],
            ],
            dtype=float,
        ),
        np.array(
            [
                2.174180985665279,
                0.0562460067882032,
                0.7561336516343455,
                1.0786040418251435,
                -0.8529489478967893,
                0.6704165679508111,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [0.12546485959979756],
                [-0.04335611825178381],
                [0.4169740946588719],
                [0.948487957775404],
                [0.10367590828453326],
                [1.0534214641754953],
                [1.2075037748436976],
                [-0.32460722481435517],
            ],
            dtype=float,
        ),
        np.array(
            [
                1.3668323974293866,
                1.4835824054923967,
                1.5839330391734672,
                1.4506290404460063,
                1.716115429376,
                1.3857076210453063,
                1.466663660096583,
                1.7538955948839294,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [-0.3132774482644722, -1.64168739253625],
                [0.030927512424524024, -0.22829599549577326],
                [0.5122842644717681, 0.06367583967402056],
                [-1.0708129560978106, -0.04357192622845013],
                [-0.33788649083316824, 0.5746982181826483],
                [0.657283372718636, -1.9885565729715822],
            ],
            dtype=float,
        ),
        np.array(
            [
                2.351998316659027,
                1.6997522914564915,
                1.5312969627366577,
                1.0197941742734264,
                1.0716773464044855,
                2.96462343609931,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [0.5269352228426429, 2.3866464865651174],
                [0.20581406917928483, 0.5891451003154276],
                [0.8755884534233014, -0.640082834811492],
                [-0.23000891926635375, 0.6322672969341011],
                [-1.0655608957006582, -0.934113230431419],
                [-0.040488502059788954, 0.5504161815380592],
            ],
            dtype=float,
        ),
        np.array(
            [
                1.0634765137709956,
                1.3343934394887926,
                0.6942238758855637,
                1.5576533590084511,
                2.319096900413939,
                1.4457611947992488,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [
                    1.1736712176488444,
                    -1.1550324015501172,
                    -1.5864928559017313,
                    0.022409724773248436,
                ],
                [
                    0.2836587127243808,
                    -0.7261627786302182,
                    0.983200763825101,
                    -0.5725457198075511,
                ],
                [
                    2.229887058563508,
                    0.581493023915714,
                    -0.25190271885027987,
                    1.1283766549709493,
                ],
                [
                    0.8139906811844476,
                    -0.2568859147104836,
                    1.1341617141599154,
                    0.46432836736558414,
                ],
                [
                    -0.7613262259159558,
                    0.20214759648227057,
                    0.02123493147156904,
                    -0.2773772225482218,
                ],
                [
                    -0.4583409299836941,
                    -0.38704370850747055,
                    -0.7534276140482773,
                    0.17381391254588882,
                ],
                [
                    1.3267183320705136,
                    0.49979539741509205,
                    0.06809401051566381,
                    -1.40225058403858,
                ],
                [
                    -0.7093960096986525,
                    0.9675163305344628,
                    1.2957245894117877,
                    -0.1459633252761745,
                ],
                [
                    -1.301782324156539,
                    0.13495954615279643,
                    0.40184979329670184,
                    0.7685866388977212,
                ],
                [
                    0.10084213727585337,
                    0.28670351054228915,
                    0.2166513401125832,
                    0.9646597566263225,
                ],
                [
                    -1.4802040029433683,
                    0.44686064325100433,
                    -0.9684075469137428,
                    0.41007461378333865,
                ],
                [
                    -0.2711401019280759,
                    -0.3932769510554725,
                    0.6145268796678449,
                    0.30701519227403545,
                ],
            ],
            dtype=float,
        ),
        np.array(
            [
                6.496737318752596,
                0.6936278434806324,
                3.678640220324322,
                0.7199022012950627,
                0.4230127136227064,
                2.648265769493083,
                2.3863407828149215,
                -2.3226976414766245,
                -0.5059482819427639,
                0.8861105908207534,
                1.2985367502522036,
                0.34461613466887764,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [1.0777791489963793, 1.0138518363710765, -0.6984999752529649],
                [-0.4771579023636158, -1.1745704101452616, -1.8264555256067025],
                [-0.1449212112150883, -0.6465430019073932, -0.5898315329014129],
                [-0.003418041419011129, 0.5949924615262123, 1.3619643939580173],
                [-1.1329541558336909, -0.2654909408129526, 1.3307647139946006],
                [-1.0799002093638217, -0.05947209566858145, 0.35092278630275797],
                [0.16601406279594105, 0.23470034572105583, -1.0720911113259628],
                [2.2164490567094215, -0.3359670946685816, 0.7942031644950288],
                [-1.801915156844731, -0.9673820830270841, -2.887792047383699],
                [0.6410113258158081, -0.49738872549270563, -0.7270000714098745],
                [1.7575265939412839, 0.5870906966684537, 0.8681856628231588],
                [0.2690973790350793, 1.033064477384938, 1.2880386057169844],
            ],
            dtype=float,
        ),
        np.array(
            [
                1.6899043083110135,
                3.163732067942071,
                1.917417744774504,
                0.048272460429040764,
                0.44536489285204084,
                1.6258462883342302,
                2.4224793386001116,
                0.03581926425141295,
                4.857550062219393,
                2.0456994929538777,
                0.10514828535137086,
                0.045195120794879945,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [-0.308470261203935, 0.19678182466739763],
                [1.0999178337592808, -1.5648000852802137],
                [-0.2331877858634972, -0.9252820039627258],
                [1.1211418781738767, -2.937670368232159],
                [0.840125048580442, 2.6268704796314566],
                [0.3552687639447912, 0.899172660222637],
                [-0.16784350741976045, -0.4377006260290963],
                [-0.04016366379593746, 0.8211919859032158],
                [1.3032076135480026, 0.29194581942548886],
                [-0.5118848942669688, 1.5578385564248511],
                [-0.7433940565252365, 2.31174074076904],
                [-0.01225354464826991, 0.33468795200376306],
            ],
            dtype=float,
        ),
        np.array(
            [
                1.2491542508802163,
                4.645301367560353,
                3.860080322043725,
                8.124147517503477,
                -5.710346588604755,
                -0.7865414160759645,
                2.7629475601697884,
                -0.4004854003038373,
                -0.039891847552813095,
                -2.1241271400459554,
                -3.5635951380736275,
                0.7681875799697044,
            ],
            dtype=float,
        ),
    ),
    (
        np.array(
            [
                [2.0256804692507915, -0.3136415920812303],
                [-0.9904600758054796, 1.1404933477218713],
                [-0.5153357201025426, 0.7295058434491241],
                [0.0410495512396989, -0.5748967933843472],
                [0.6611164402004215, 0.7543367706222095],
                [-0.8548459027650214, -1.7954931267488001],
                [0.46033836599328987, 0.6067488775120834],
                [0.9264430844538349, 0.16812609490074876],
            ],
            dtype=float,
        ),
        np.array(
            [
                -1.3759453704516407,
                3.4349497756628913,
                2.6376083509975334,
                1.2183071187784025,
                1.1218198426258137,
                1.7416666740784101,
                1.1947429096184587,
                0.22165526884911146,
            ],
            dtype=float,
        ),
    ),
]


@pytest.mark.parametrize("X_raw, y", TEST_CASES)
def test_federated_ols_matches_statsmodels(X_raw, y):
    _run_and_compare(X_raw, y)
