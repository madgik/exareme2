import numpy as np
import pytest
from sklearn.decomposition import PCA
from sklearn.pipeline import Pipeline
from sklearn.preprocessing import StandardScaler

from exaflow.algorithms.federated.pca import FederatedPCA


class DummyAggClient:
    def sum(self, value):
        return np.asarray(value, dtype=float)


def _components_match(a, b, atol=1e-8):
    a = np.asarray(a, dtype=float)
    b = np.asarray(b, dtype=float)
    for i in range(a.shape[0]):
        ai = a[i] / np.linalg.norm(a[i])
        bi = b[i] / np.linalg.norm(b[i])
        if not np.isclose(abs(np.dot(ai, bi)), 1.0, atol=atol):
            return False
    return True


def _run_and_compare(X):
    agg_client = DummyAggClient()
    model = FederatedPCA(agg_client=agg_client)
    model.fit(X)

    sk_model = Pipeline(
        [
            ("scaler", StandardScaler(with_mean=True, with_std=True)),
            ("pca", PCA(svd_solver="full")),
        ]
    )
    sk_model.fit(X)

    assert model.n_samples_seen_ == X.shape[0]
    assert np.allclose(
        model.explained_variance_,
        # sklearn StandardScaler uses population variance (ddof=0); our PCA uses sample variance (ddof=1)
        sk_model.named_steps["pca"].explained_variance_
        * ((X.shape[0] - 1) / X.shape[0]),
        atol=1e-8,
    )
    assert _components_match(
        model.components_, sk_model.named_steps["pca"].components_, atol=1e-8
    )

    identity = np.eye(model.components_.shape[0], dtype=float)
    assert np.allclose(model.components_ @ model.components_.T, identity, atol=1e-8)


TEST_CASES = [
    np.array(
        [
            [
                1.1108714734285123,
                0.9675940682407447,
                1.521360800622028,
                -0.04824988226561448,
                1.5953011188100306,
                -1.7830943139593969,
            ],
            [
                -0.2864514709599152,
                -1.041968961197559,
                -1.4796451457528315,
                1.0712820693753538,
                0.8074848819217928,
                -1.0582672465463288,
            ],
            [
                1.7300244938421832,
                1.2326501583151765,
                -0.8235983719096136,
                -0.11820134852472614,
                -0.5761031882161003,
                1.6957307176807583,
            ],
            [
                -0.07439424025572473,
                -1.9006370181621457,
                -0.7776548606324216,
                1.313461981753642,
                1.804457889274741,
                -0.9655500259283023,
            ],
            [
                -1.316480034439269,
                -0.625785156649337,
                -0.3269462270973604,
                -0.3082091962166388,
                0.8271174641505916,
                1.0707814176564971,
            ],
            [
                -3.055577417640911,
                1.0059319345639077,
                -1.7650564344909274,
                0.6117179065600088,
                2.0033592833410725,
                -0.02941930694454622,
            ],
            [
                -1.582939560984903,
                -0.026711030508230305,
                1.5716695676108334,
                -0.3945018436406461,
                1.4342287163638596,
                -0.0920471744917294,
            ],
            [
                -0.5202823049204828,
                -1.6979998255486655,
                0.7681257667837189,
                0.39360257902506013,
                -0.31717380527619005,
                -1.702728286410563,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                1.4956441370334692,
                1.0693926697057368,
                -0.7727087142471915,
                0.7948626677932181,
                0.31427199450686705,
            ],
            [
                -1.326265459940456,
                1.4172990464768525,
                0.8072365345785665,
                0.045490080631097156,
                -0.2330920609844135,
            ],
            [
                -1.198301144700787,
                0.19952407355863258,
                0.46843911944564426,
                -0.8311549842432792,
                1.1622040490995293,
            ],
            [
                -1.0972030464830342,
                -2.1231003500424417,
                1.0397270908927005,
                -0.4033660381021075,
                -0.12602958531301514,
            ],
            [
                -0.8375167228250533,
                -1.6059627607174027,
                1.2552373747242185,
                -0.6888689838469215,
                1.6609524881479396,
            ],
            [
                0.8073081862107286,
                -0.31475814671745994,
                -1.0859024011268665,
                -0.732461986720457,
                -1.2125231310951696,
            ],
            [
                2.0871133595881854,
                0.16444123022982496,
                1.1502055425466322,
                -1.2673520490102275,
                0.18103512959700388,
            ],
            [
                1.1778619388085783,
                -0.3350107619330159,
                1.0311144589217422,
                -1.0845679120057665,
                -1.3634715446185843,
            ],
            [
                0.37940061207813613,
                -0.3791764345725522,
                0.6420546892718314,
                -1.977887931520449,
                0.7122646354705182,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                2.5983039272693147,
                -0.024625981431480627,
                0.03414212890984157,
                0.17954948463867915,
            ],
            [
                -1.8619757107917871,
                0.4261466396903099,
                -1.6054097440159647,
                -0.42767959812380435,
            ],
            [
                1.242869549603737,
                -0.7352169561000764,
                0.5012489895674,
                1.0127390539563705,
            ],
            [
                0.2787408560959998,
                -1.3709484700946077,
                -0.3324752753514139,
                1.959411342388286,
            ],
            [
                -2.025045762997471,
                -0.27578601386617546,
                -0.5521080714881078,
                0.12074736309713868,
            ],
            [
                0.7482156171872304,
                1.6086909680220534,
                -0.2702323920091581,
                0.8123413299768204,
            ],
            [
                0.49974014486517293,
                0.4743472978718003,
                -0.5639239315264725,
                -0.9973214687759007,
            ],
            [
                -1.100043112620697,
                -0.7564372093991233,
                0.3216865758662266,
                0.7609493931283295,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                0.32346884785689517,
                -1.9093182181014148,
                -1.844006425235508,
                0.3738340538834407,
                1.5097338000247391,
                0.15947411462979783,
                -0.8007278333203633,
            ],
            [
                -0.5390447506040743,
                1.0416195803943922,
                0.09443589019125635,
                0.16105240116093625,
                1.540950307871455,
                0.4535322886687095,
                -0.2871559159318085,
            ],
            [
                -1.031899983499122,
                1.6213234348165098,
                -1.9724567320371111,
                -0.24067951455712674,
                -0.30448120319916905,
                -0.13973320955066082,
                1.3603175561029806,
            ],
            [
                0.7410732734523487,
                0.0885185103733558,
                -1.35339632100267,
                0.3784088033766745,
                -0.8108865759360823,
                1.4591407998299135,
                -0.027540764546945824,
            ],
            [
                0.00985259606259537,
                -0.3099946753648837,
                0.09005601070509248,
                -0.1851128804295578,
                1.672834049222523,
                0.11699668628032656,
                -1.0379389257110767,
            ],
            [
                0.1938015317195221,
                -0.5474511584192208,
                -0.9071238650487508,
                0.16841519202188074,
                1.0251040742332966,
                1.271039492031887,
                -2.6573147050649806,
            ],
            [
                0.6709068558605431,
                -0.41734603968497375,
                1.3600895520189185,
                -1.3386952823648695,
                -0.07978120783133337,
                0.8900942677565564,
                -0.46028317089236864,
            ],
            [
                -0.33665606473293164,
                -1.2744178914661926,
                -0.07877032924929,
                -0.8857258649690111,
                -1.9868294420280534,
                0.02363256297837662,
                -0.20936790188369822,
            ],
            [
                -0.3235265704571591,
                -0.052034752902540414,
                -0.12000961506326363,
                0.03119318377340684,
                0.3794698436776568,
                0.3041076120361065,
                -0.009397675527046132,
            ],
            [
                -0.7876070105551478,
                -0.2439554902797589,
                0.5403870135409035,
                -0.0444574773895266,
                1.105394268094984,
                -0.5848987504994155,
                -0.592706689574886,
            ],
            [
                0.6071197449236385,
                1.7385951459784246,
                -0.4566792969269225,
                -1.2757772092561555,
                -0.36944785791250523,
                0.0817962610264088,
                0.25365965762949744,
            ],
            [
                0.015523179632070956,
                -1.7470727330138154,
                -0.6315217624776248,
                -1.323940985830361,
                -0.2597337529898967,
                -0.18826506243399763,
                -0.7601598611837145,
            ],
            [
                -1.0199020374086776,
                -1.3910035113340264,
                0.854841861799772,
                0.5544724044157795,
                -2.197222431889994,
                0.3285394101375218,
                -1.1396651446296449,
            ],
            [
                0.9078976312922502,
                -1.422155850714585,
                0.3911165149864693,
                0.6917119873060813,
                -0.08290280659189592,
                0.5415807420048,
                -0.3409489272194327,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                0.8826062729773012,
                -0.5025875221098767,
                0.7644959205607067,
                -0.8233703767034665,
            ],
            [
                0.07741968128136704,
                -1.9618879415638983,
                0.9465496574811963,
                1.1120125227581985,
            ],
            [
                -1.3167301549057646,
                1.3426949756522633,
                -0.9050631821013198,
                0.33897485848089826,
            ],
            [
                0.09301207763775057,
                -0.9594073841651874,
                -0.8269146112317171,
                -0.009787920855716947,
            ],
            [
                -0.534419586870754,
                1.1857084257690749,
                -1.4556673128433177,
                0.743391454835077,
            ],
            [
                -0.32353374200074914,
                -0.46197074230124174,
                0.26114286406699017,
                0.6668523674312498,
            ],
            [
                0.36233741138120273,
                0.4280460874381981,
                0.03647452060768332,
                -0.5628565176008908,
            ],
            [
                -0.036640645961583215,
                2.932144889450922,
                1.8109566189120379,
                1.178877733518178,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                0.27788676848956434,
                1.4083691460769014,
                -0.6087108032644418,
                -1.3206025797896521,
            ],
            [
                -0.6696185998697584,
                1.2646252869680072,
                -1.4202129989485122,
                -0.8664952037596095,
            ],
            [
                -0.6668075087965194,
                -1.2511898734731952,
                -1.1843273385116637,
                -1.5181079752636586,
            ],
            [
                -0.46118741313672207,
                -0.35490883174008503,
                -0.6825381542033059,
                -1.653697838967641,
            ],
            [
                1.2533359468559955,
                -1.3290788291721605,
                0.27803371202287097,
                -1.0747665931188752,
            ],
            [
                0.6683168667415277,
                0.9558323551671646,
                -0.8776135866276552,
                -1.923715729697126,
            ],
            [
                0.6957873191396077,
                1.8758005467136352,
                0.415694539892434,
                0.16054442147971804,
            ],
            [
                0.8197606096101892,
                0.7650548459970179,
                -0.8289888337610103,
                -0.6591513106966477,
            ],
            [
                0.6111235500559109,
                -0.14401334748029268,
                1.3166055958635523,
                -0.7043421471287583,
            ],
            [
                0.7506099168684812,
                0.3426379813692278,
                -0.12643756370963435,
                1.1759107718346071,
            ],
            [
                0.6800715328674297,
                -1.004967153382104,
                0.6402186804198472,
                1.374990631494199,
            ],
            [
                -0.13044468898462372,
                -0.24865585038497331,
                -0.6696471476435246,
                -0.013603885675351006,
            ],
            [
                0.68620068605291,
                -0.8176682995787476,
                -1.34635756073724,
                -0.37574991098192634,
            ],
            [
                -1.37972497865875,
                0.5232184412826316,
                -0.4266897699938011,
                -1.7554018445508066,
            ],
            [
                -0.3486075147385099,
                -0.19261498579409048,
                0.4491356133597169,
                -0.14536354315421035,
            ],
            [
                1.8687264568398085,
                -0.5187038515389994,
                -0.06239854858230655,
                -0.10291061426267058,
            ],
            [
                -0.28262838440702354,
                0.14242558501294,
                0.5412312971976727,
                1.3400987035364347,
            ],
            [
                -1.5692561273944634,
                -0.5103428738061208,
                -0.4477714253522432,
                0.937850297361706,
            ],
            [
                -0.3566630610733439,
                -1.8951755930793188,
                0.0877304638665764,
                -0.03368923154093914,
            ],
            [
                0.17975156577131524,
                -1.040162880979482,
                1.7190346810845034,
                -0.32385978378534624,
            ],
            [
                -0.18829685849366687,
                -0.9000085698091608,
                -0.9310020038747236,
                -1.2227369597487854,
            ],
            [
                -0.3933108517811569,
                -0.957581838756634,
                2.0564673412252215,
                -1.8884923803868152,
            ],
            [
                -1.1283305481817938,
                -0.40141442845701475,
                0.6734912780983248,
                -0.41375688138006245,
            ],
            [
                0.6759633930029775,
                -0.9868038892903219,
                0.05929113389470675,
                1.7440410870108336,
            ],
            [
                -0.9677443956994779,
                0.4195676758953945,
                0.2069275192832601,
                -2.25153498598787,
            ],
            [
                -0.5889705464706788,
                1.1311519053059893,
                0.1350776724846987,
                -1.2122689628960637,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                0.6907772729156428,
                -0.42356391058175125,
                0.30083336558367696,
                1.64829241825197,
            ],
            [
                -1.2199783792335259,
                0.8066558262068521,
                0.20798858359430974,
                0.06343131498676677,
            ],
            [
                0.5641852329967054,
                1.4254633525228255,
                -1.4839484547870081,
                -0.6941655992596616,
            ],
            [
                -0.2935512448834033,
                -1.4339187716663213,
                0.17450349484721558,
                0.558030215818324,
            ],
            [
                0.08170425727323227,
                0.6355292563223428,
                -1.402833005184545,
                -0.6764361323490472,
            ],
            [
                0.03048995316235359,
                -0.13270161579316042,
                0.002486220088807506,
                0.5663249430639953,
            ],
            [
                -0.6601419517767598,
                -1.2361867716218868,
                -0.9398334467214086,
                1.2274931431396057,
            ],
            [
                -1.9635619969623268,
                -1.3012374012851819,
                0.2656293710619027,
                0.2952669016763157,
            ],
            [
                -0.4846583466223481,
                0.5448295258987689,
                0.5199825668864624,
                0.3864808667667455,
            ],
            [
                0.2869133258120478,
                -0.2600388642276947,
                1.0462666315965463,
                0.4499319472478074,
            ],
            [
                0.548618405849543,
                1.1060155391361233,
                0.711301512871492,
                1.0928591374962315,
            ],
            [
                -0.8485438706261984,
                0.18263489907989638,
                -1.1139608571701118,
                0.7822537812905285,
            ],
            [
                -0.7878574290049626,
                -0.8751188517009644,
                2.0966556615776737,
                0.15985731261570188,
            ],
            [
                0.25153840649383413,
                0.7457353347948231,
                -0.28411692967657526,
                -0.23392603815767007,
            ],
            [
                0.7636525994334049,
                0.9606839535884875,
                -1.1125588036908638,
                0.4663736169752891,
            ],
            [
                0.2943990872503594,
                0.8288529089155761,
                -0.043241185282283705,
                0.6410816966080396,
            ],
            [
                -1.0067904457364336,
                0.28511252475357857,
                -1.2907908624422011,
                0.8204493526816723,
            ],
            [
                -0.4471537324903699,
                -1.6117439275667995,
                -0.8555861057578047,
                -0.2715837928997084,
            ],
            [
                0.7672278501867075,
                1.1637816424603784,
                -0.523668290315723,
                -0.30989557788202315,
            ],
            [
                0.833737809636127,
                -0.78712165901937,
                -0.37605971808499755,
                -0.5409156576247224,
            ],
            [
                0.8258392929132863,
                -0.7128205390875576,
                0.8883252750707939,
                1.1142114890065447,
            ],
            [
                0.02472263276426288,
                0.9205656050144391,
                -0.32548426274254494,
                1.4218168814769525,
            ],
            [
                0.4777796220333877,
                -0.8556412129950116,
                -0.3853922083397685,
                -1.2583026316238621,
            ],
            [
                0.5764918316922956,
                -0.20337122373940414,
                1.3669572795213287,
                0.8781483423910835,
            ],
            [
                0.9098474245826401,
                0.5508938230637355,
                0.2100143928094986,
                0.5065871961231793,
            ],
            [
                0.7471432323996705,
                1.6981776272621123,
                1.0849881397389696,
                0.9524109103765514,
            ],
            [
                1.3051582704501192,
                -2.783575972015,
                -0.7791269645235543,
                0.11587678971548676,
            ],
            [
                -0.9690584153701615,
                -1.0686187215578549,
                -0.06156280267308837,
                1.2406002697466063,
            ],
            [
                -0.703286836133453,
                0.7679591465577751,
                1.9409599730872544,
                -1.1913315070833927,
            ],
            [
                0.3540186244624026,
                0.506841270129435,
                -0.6650623872120911,
                -0.34307770997811576,
            ],
            [
                1.4053106949928129,
                -0.3471515364201193,
                -0.507782757637622,
                1.9061192418918356,
            ],
            [
                1.9777446315880467,
                -0.33045862838368034,
                -0.08441006444288865,
                -0.9468997558883494,
            ],
            [
                0.4682141656148449,
                2.791387337460528,
                0.9790579369502009,
                -1.1112265572735447,
            ],
            [
                0.9515470851871488,
                1.5869537167725098,
                -1.9940225976765371,
                -1.3042813023538471,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                -1.3958003426900583,
                -0.12237629576132082,
                0.03074007421300566,
                0.6684891368158643,
                -0.6089979645557254,
                -0.1284958349231744,
            ],
            [
                1.0485726938897553,
                -1.3781143431574669,
                -0.8208525045561596,
                -0.4484523811976761,
                -0.5131610157663054,
                1.2042483864618994,
            ],
            [
                0.7077749584109665,
                -0.43635111857703573,
                0.40220192862679477,
                1.6472106731316121,
                1.6810453240930978,
                0.07458696449247378,
            ],
            [
                0.2210925964782044,
                0.5710607183040481,
                2.582782694935338,
                -0.3791387618404319,
                0.25471067707544176,
                -2.067819596165466,
            ],
            [
                -0.016169182764741337,
                1.1771028139831741,
                -0.5111676664010974,
                1.3334197324014434,
                -0.580561718276151,
                1.1807690953084349,
            ],
            [
                -0.20431628206404492,
                -0.03607105519395142,
                -0.8100377251439466,
                -1.706419659263923,
                -0.24002979240829231,
                -0.8997614264000039,
            ],
            [
                -0.12598009667208346,
                -0.6693220305719565,
                -0.8588598986617179,
                -2.1109042135736247,
                -0.2061004280762489,
                -0.1346447729988322,
            ],
            [
                1.539664822033912,
                0.5265076516478093,
                -1.3209160643704219,
                1.018038754941764,
                -0.9412331386357391,
                0.09840451288681736,
            ],
            [
                -0.18385287331135669,
                0.0005007764632208649,
                0.20818056715314348,
                0.43435930027761926,
                -1.3339888511080182,
                1.5026528835395814,
            ],
            [
                1.1099618415789609,
                -0.46242357877369533,
                0.12257980931274495,
                -0.9999653928636378,
                0.6055447025122979,
                0.04815075206457783,
            ],
            [
                -0.4466620986685872,
                0.3258780626173199,
                0.28366315443374035,
                0.29836879265864663,
                -0.7255579103470379,
                -1.0195611280242383,
            ],
            [
                1.0423466984555878,
                0.03466934845357874,
                -0.7732447129501824,
                -1.0599982059062762,
                0.8066627201346734,
                0.7545514574942061,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                -1.9142212084965766,
                0.22483923818881657,
                -1.2462111735656407,
                1.100784176709294,
                -0.33786283875303325,
            ],
            [
                -0.03384576368271748,
                -0.29672734594843875,
                1.2853376001302101,
                -1.1414848135336255,
                1.0591390903784281,
            ],
            [
                0.4183778032715033,
                -0.5680711870664972,
                -1.0682463497514658,
                -1.1757090611822212,
                0.047841317616385486,
            ],
            [
                -0.8541632836060761,
                -1.304680772692182,
                -0.6180169298754126,
                0.6955757286594048,
                1.0993295046875253,
            ],
            [
                0.3604059380883436,
                0.23892184012444492,
                1.027777096141017,
                1.1365563130770004,
                1.368642265073603,
            ],
            [
                0.3798681341184839,
                -2.335893035140532,
                -0.47258396823171456,
                0.028352412058767602,
                0.14173248626403587,
            ],
            [
                -0.016576261400563407,
                1.0189626535359741,
                -0.5047775353080363,
                -1.828985172259124,
                0.6934663699818766,
            ],
            [
                0.5998022036610464,
                -1.7999721046684676,
                0.8120456104830033,
                0.9295980653301092,
                0.9039530469774716,
            ],
            [
                1.6778863270665774,
                -0.7337981271398134,
                -2.034545463452051,
                0.12232096163450358,
                0.5343786542299686,
            ],
            [
                1.1929061666599683,
                0.1092098758688141,
                0.2803647839703429,
                1.899509223625446,
                1.191916971519225,
            ],
            [
                -0.16411120657574754,
                -0.7362471870019446,
                -0.8069140806250669,
                1.1748566748938882,
                -0.6132652680923716,
            ],
            [
                0.6141747279244824,
                -0.27215628238706796,
                1.382042919442862,
                -0.5776795488224218,
                1.8714440825726613,
            ],
            [
                -1.7079861221848711,
                -0.8734673766638568,
                -0.30241140884461787,
                -0.3509482211076724,
                1.4902002852019638,
            ],
            [
                1.6270382367015945,
                -1.1342385908586972,
                -0.7774033183637965,
                -2.0350941577681736,
                0.7917278608919437,
            ],
            [
                0.6392329285956757,
                -0.2012857988223442,
                0.6988383109729267,
                0.6094211809545659,
                -1.6578218989464344,
            ],
            [
                2.0037674180731218,
                1.0748184158590537,
                -1.1310568692846807,
                1.702560682564444,
                0.9155391288137777,
            ],
            [
                -0.2549902290410451,
                -0.9831243178768376,
                0.9920383684980513,
                -0.07950828734863756,
                0.6827146408525547,
            ],
            [
                -0.8417447227844131,
                0.778808334020414,
                -0.2924451117685433,
                0.9635364162335533,
                1.1464260236585335,
            ],
            [
                0.1188802412857961,
                0.16637096467251716,
                1.0873100305312369,
                1.2556222296331725,
                0.4455369043778574,
            ],
            [
                -0.1052278403484731,
                -1.827447017587533,
                -1.5950579162757963,
                -0.7838105870239465,
                -1.1724912297632,
            ],
            [
                0.4010367956895203,
                1.1101692311754499,
                -0.598409011939777,
                0.5121875150493236,
                1.069725984448855,
            ],
            [
                0.804010441081194,
                0.17912672748078237,
                -0.9397833333611949,
                -0.5300875746324871,
                1.1255177274164236,
            ],
            [
                -1.9500755972598711,
                -1.582046653791336,
                1.6107710430897482,
                -0.2365657020978802,
                0.988032212298993,
            ],
            [
                1.6209458410142623,
                1.394544595437522,
                0.7578749601374866,
                0.14954552137430824,
                -0.9683771346974134,
            ],
            [
                0.5956626140404316,
                0.28059893659300544,
                -0.6513957364419447,
                -1.558938281262163,
                1.4796234185934856,
            ],
            [
                -0.022230525328094518,
                -1.2378635267253817,
                -0.14423147663052063,
                -0.12265183895159171,
                0.0573461604097457,
            ],
            [
                1.0901633966856032,
                1.1592360170304017,
                -0.9557936004198209,
                -0.7904509696554908,
                -1.1767842594063982,
            ],
            [
                0.5855615565869762,
                -0.7328974729371293,
                -0.18944758037774748,
                1.0576197494258097,
                -1.190155779375004,
            ],
            [
                -1.6118735528209156,
                -0.46972710302981524,
                -1.1102028916885194,
                -0.6472518485135289,
                -0.9991588569532978,
            ],
            [
                0.5121407311174343,
                0.2897890328963719,
                0.7623518878141768,
                -0.558781800752293,
                0.2538704461619936,
            ],
            [
                -0.7293432255595318,
                0.4400299122464011,
                0.44802618040080305,
                0.6941859953999051,
                -1.0824124480013178,
            ],
            [
                1.7883098721563377,
                -0.34797616264200326,
                0.7002746272111129,
                -2.5988697493645825,
                -0.08077328525109245,
            ],
            [
                0.6872568474314393,
                -1.07747192875352,
                -0.5613136032891379,
                0.22175693224048798,
                1.5649407458345543,
            ],
            [
                0.4519732224528259,
                0.997351081171262,
                -1.8852599148130904,
                -1.9507696736295717,
                -0.39249026573651447,
            ],
            [
                0.9220798216850028,
                0.06309530020625698,
                0.9382858071814565,
                -0.789839511931944,
                -0.8887548164177865,
            ],
            [
                0.4895412349497816,
                1.0994536177388592,
                0.905097922424175,
                -0.02002359487786325,
                0.0073819639191551765,
            ],
            [
                -1.2392755624580931,
                0.464300711155761,
                0.16369483950790192,
                0.07478207603513683,
                1.455809738109936,
            ],
        ],
        dtype=float,
    ),
    np.array(
        [
            [
                -1.3992338686095869,
                1.0576951014282159,
                -0.6615506465805062,
                -0.9297116344424167,
                -0.6925831159713568,
                -0.05746612700083015,
                -1.1584159108657917,
            ],
            [
                0.12651650597023537,
                -1.3600076771230591,
                0.7740000020757852,
                -1.0570557773396025,
                1.3202683189321007,
                -0.010032652757383347,
                -0.8456444283952297,
            ],
            [
                0.9114606095823158,
                -1.3744968791031125,
                -0.5470656450174095,
                -7.552661061545873e-05,
                -0.12116680328820885,
                -2.008585468370626,
                -0.9206465426133663,
            ],
            [
                0.1682343424234322,
                -1.3198915593599103,
                1.2664292986658463,
                0.4951808887859862,
                -0.5142403907110708,
                -0.2202924653000638,
                1.8615641238318181,
            ],
            [
                0.9359884508763173,
                0.38021914486617187,
                -1.4155187704342762,
                1.6296113186459584,
                1.052401068873978,
                -0.14840538755987095,
                -0.5496980692087847,
            ],
            [
                -0.18790393877677286,
                -1.2019366808669738,
                -0.47078555770734065,
                0.7631605141545158,
                -1.8076212772425719,
                -0.3140743742422747,
                0.11375597287983731,
            ],
            [
                0.10356803732332855,
                -1.1789369540334256,
                -1.1821528913270605,
                1.0891653824583838,
                -1.2245290928162911,
                1.0086509563084367,
                -0.48236531510849157,
            ],
            [
                1.0797963503009356,
                -0.42107850540501407,
                -1.1664713206163051,
                0.8565548563934619,
                -0.01739122223019718,
                1.4485765853244514,
                0.892200085137838,
            ],
            [
                -0.22942662894379623,
                -0.4496676016629738,
                0.023372343287248552,
                0.19021001785918956,
                -0.8817485267318087,
                0.8419395730245767,
                -0.39736349181039743,
            ],
            [
                -0.42302774515331237,
                -0.5406883373725029,
                0.2310172673433714,
                -0.6920526017208553,
                0.13497010999029418,
                2.766603071101871,
                -0.053609460071342124,
            ],
            [
                -0.43400473829864827,
                -1.667689228147901,
                0.05022192476406931,
                -1.1092309432496061,
                -0.37555811897157276,
                0.15160759364714313,
                -1.7309894498221519,
            ],
            [
                0.1574627523984585,
                0.3045151754260446,
                -1.2971000196666516,
                -0.39230919212908744,
                -1.8306663621778045,
                1.5755009358424055,
                0.33056327654884465,
            ],
            [
                -0.17958850097910234,
                -0.16343583065616263,
                1.1314436080657682,
                -0.09416555192061088,
                0.3308167712757532,
                1.5186295603654949,
                -0.3461671480021981,
            ],
            [
                -1.0926353245067322,
                -0.824500574753621,
                1.4286638344392986,
                0.09142830851405706,
                -0.5023312882696742,
                0.9736443797991589,
                0.9979573856771604,
            ],
            [
                -0.4756477679064388,
                -0.9719368370854505,
                -1.5705286010612101,
                -1.793888920926237,
                -0.2649864518459969,
                -0.8931959470367929,
                1.8584744098061854,
            ],
            [
                0.0585377546950242,
                -1.9421495432511602,
                1.4187292755100624,
                0.1617103094175957,
                0.7049794803731054,
                0.6820347768334102,
                0.29655656728653923,
            ],
        ],
        dtype=float,
    ),
]


@pytest.mark.parametrize("X", TEST_CASES)
def test_federated_pca_matches_reference_fixed_random_cases(X):
    _run_and_compare(X)
