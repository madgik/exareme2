import numpy as np
import pandas as pd
import pytest
import statsmodels.api as sm
from statsmodels.formula.api import ols

from exaflow.algorithms.federated.anova_twoway import FederatedAnovaTwoWay
from tests.standalone_tests.federated_algorithms.utils import DummyAggClient

TEST_CASES = [
    {
        "y": np.array(
            [
                -1.75963473,
                -1.91171657,
                -1.94165748,
                -1.70617786,
                -1.55994048,
                -2.02038727,
                -0.86518119,
                -0.14508482,
                -1.22377994,
                -0.38646418,
                -0.08502459,
                -0.79061523,
                -1.16660204,
                -0.99043799,
                -0.28611268,
                -0.67504065,
                -1.54492359,
                -0.82179953,
                0.95305153,
                0.93796081,
                0.76112411,
                0.32707373,
                -0.47636681,
                0.530892,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
        ],
        "levels_a": ["a1", "a2"],
        "levels_b": ["b1", "b2"],
        "sstype": 2,
    },
    {
        "y": np.array(
            [
                -0.49604934,
                -0.90452173,
                -1.02578785,
                -0.60468349,
                0.33691104,
                -0.17661066,
                -0.15173881,
                0.26750358,
                -0.51051605,
                -0.83253748,
                0.12214521,
                0.38969317,
                -0.23519421,
                0.31794925,
                0.4911773,
                0.12837485,
                -0.02125586,
                1.35710759,
                1.78741331,
                1.22222264,
                0.96699066,
                1.53128558,
                0.05293735,
                -0.45568586,
                -0.03334665,
                2.13503153,
                1.51011558,
                1.20683602,
                1.78741909,
                1.73736667,
                2.16300018,
                0.97130341,
                1.28278733,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
        ],
        "levels_a": ["a1", "a2", "a3"],
        "levels_b": ["b1", "b2"],
        "sstype": 2,
    },
    {
        "y": np.array(
            [
                -0.3275217,
                0.70139472,
                0.17439101,
                1.51555733,
                1.07128717,
                1.37420683,
                0.87060461,
                1.75392904,
                1.77644299,
                1.27529657,
                1.19881189,
                1.39011151,
                1.1447719,
                1.93256582,
                2.08804784,
                1.86552666,
                2.61289942,
                1.43169236,
                2.64151659,
                1.91695229,
                2.49239175,
                2.08993816,
                2.69324067,
                2.64153097,
                3.24555355,
                2.88293849,
                3.19670373,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b3",
            "b3",
            "b3",
            "b3",
            "b3",
            "b3",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b3",
            "b3",
            "b3",
        ],
        "levels_a": ["a1", "a2"],
        "levels_b": ["b1", "b2", "b3"],
        "sstype": 2,
    },
    {
        "y": np.array(
            [
                2.13223201,
                1.41269368,
                3.50654797,
                2.55479879,
                3.33558295,
                2.87567703,
                2.43231824,
                2.22889185,
                1.61948608,
                -2.47200474,
                -3.68744821,
                -2.58307738,
                -3.95259827,
                -3.04076827,
                -1.50552445,
                -1.92614661,
                -2.22153143,
                -3.76783659,
                -3.53645658,
                -2.839494,
                -2.91963685,
                -3.4961223,
                -3.98805874,
                0.74711368,
                -0.31482191,
                0.14468761,
                0.04270087,
                2.51373271,
                2.26007498,
                1.43284436,
                1.33812095,
                0.86295193,
                1.46965498,
                1.90814718,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
        ],
        "B": [
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b3",
            "b3",
            "b3",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b3",
            "b3",
            "b3",
            "b3",
            "b3",
            "b3",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b3",
            "b3",
            "b3",
            "b3",
            "b3",
        ],
        "levels_a": ["a1", "a2", "a3"],
        "levels_b": ["b1", "b2", "b3"],
        "sstype": 2,
    },
    {
        "y": np.array(
            [
                0.30171876,
                -0.01136827,
                0.41183475,
                1.0214539,
                1.76139136,
                2.93184235,
                2.19045881,
                1.96459649,
                -0.74887539,
                -0.72803623,
                -0.85928801,
                -0.6460457,
                -1.76513804,
                -0.639712,
                -0.62395652,
                0.10570819,
                -0.72545491,
                -1.21392298,
                -0.75089706,
                -1.21837163,
                -0.37222462,
                -0.89288963,
                -0.45204464,
                -1.43611853,
                -0.06888183,
                -1.02912115,
                -0.19595758,
                -2.77865294,
                -3.75615118,
                -3.04410137,
                -3.47690378,
                -3.00099637,
                0.29441307,
                -0.07749078,
                0.11214174,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
        ],
        "levels_a": ["a1", "a2", "a3", "a4"],
        "levels_b": ["b1", "b2"],
        "sstype": 2,
    },
    {
        "y": np.array(
            [
                -0.32273272,
                -1.00543074,
                -1.63926993,
                -1.26903132,
                -1.26228625,
                -1.20501616,
                -0.67314496,
                -1.1033532,
                -1.31662772,
                -1.82983643,
                -2.23581703,
                -2.62222764,
                -2.64029355,
                -1.44535736,
                -1.20226181,
                -0.8260983,
                -1.85440195,
                -1.50886412,
                -1.95424027,
                -1.75891778,
                -2.68747552,
                -1.17832987,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
        ],
        "levels_a": ["a1", "a2"],
        "levels_b": ["b1", "b2"],
        "sstype": 1,
    },
    {
        "y": np.array(
            [
                -0.76730688,
                -0.11144633,
                -0.38634553,
                -0.38539955,
                -0.49901016,
                -0.75920927,
                -1.60544283,
                1.07576555,
                -0.17329377,
                0.67146218,
                0.5092238,
                0.63205587,
                0.68958805,
                0.39649838,
                1.27152236,
                0.17847994,
                1.21698289,
                -0.02494286,
                1.39633776,
                0.54868769,
                0.99019779,
                1.55719921,
                -0.27816964,
                0.64585749,
                2.29685578,
                2.45974572,
                2.68924593,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
        ],
        "levels_a": ["a1", "a2", "a3"],
        "levels_b": ["b1", "b2"],
        "sstype": 1,
    },
    {
        "y": np.array(
            [
                0.48233387,
                2.42556873,
                1.79104073,
                1.25983442,
                2.16725494,
                1.50614991,
                0.70634412,
                0.41449718,
                0.90914933,
                0.22642102,
                -0.75795728,
                -0.61053609,
                -0.13267668,
                0.50761652,
                -0.52983551,
                1.62568037,
                -0.47486709,
                -0.42814983,
                -0.66064321,
                0.25983862,
                0.87541925,
                -0.14029453,
                -0.21812568,
                0.06436373,
                -0.20601688,
                -1.7282522,
                -2.33942054,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b3",
            "b3",
            "b3",
            "b3",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b3",
            "b3",
        ],
        "levels_a": ["a1", "a2"],
        "levels_b": ["b1", "b2", "b3"],
        "sstype": 1,
    },
    {
        "y": np.array(
            [
                -0.67489135,
                -1.4759613,
                -1.21425751,
                2.57108832,
                2.38340892,
                2.38189396,
                1.98939949,
                2.43679744,
                1.89816408,
                1.77368589,
                -0.32152634,
                0.03407789,
                -0.64345391,
                0.03410903,
                0.85221914,
                0.95704382,
                0.83351501,
                1.37855182,
                1.30924574,
                0.93202868,
                0.61406592,
                1.76152631,
                1.10283552,
                -0.24153122,
                0.32948305,
                0.27550566,
                0.69262115,
                0.2183758,
                2.68509441,
                3.72385489,
                1.6545577,
                1.94376055,
                2.3894413,
                2.39366056,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b3",
            "b3",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b3",
            "b3",
            "b3",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b3",
            "b3",
            "b3",
            "b3",
        ],
        "levels_a": ["a1", "a2", "a3"],
        "levels_b": ["b1", "b2", "b3"],
        "sstype": 1,
    },
    {
        "y": np.array(
            [
                3.00098887,
                2.00897628,
                2.10601795,
                2.75842475,
                0.05618354,
                -0.46326661,
                0.50810034,
                -0.05133002,
                -0.53118025,
                -0.28713744,
                3.8936999,
                3.2064413,
                3.56699052,
                3.0781406,
                3.83631851,
                2.07104484,
                1.12179973,
                1.9257682,
                2.11419095,
                2.62371158,
                0.97305989,
                0.62505131,
                0.95659365,
                0.61840828,
                1.37789827,
                1.25423067,
                1.83112461,
                1.49446484,
                2.77247946,
                2.18671281,
                2.42877235,
                2.13185809,
                2.9995754,
                0.30287469,
                0.14411927,
                -0.26040582,
                -1.55904183,
            ],
            dtype=float,
        ),
        "A": [
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a1",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a2",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a3",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
            "a4",
        ],
        "B": [
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b2",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b1",
            "b2",
            "b2",
            "b2",
            "b2",
        ],
        "levels_a": ["a1", "a2", "a3", "a4"],
        "levels_b": ["b1", "b2"],
        "sstype": 1,
    },
]


@pytest.mark.parametrize("case", TEST_CASES)
def test_federated_anova_twoway_matches_statsmodels(case):
    levels_a = case["levels_a"]
    levels_b = case["levels_b"]
    sstype = case["sstype"]
    df = pd.DataFrame(
        {
            "y": case["y"],
            "A": pd.Categorical(case["A"], categories=levels_a),
            "B": pd.Categorical(case["B"], categories=levels_b),
        }
    )

    agg_client = DummyAggClient()
    model = FederatedAnovaTwoWay(agg_client=agg_client, sstype=sstype)
    model.fit(
        data=df,
        y="y",
        x1="A",
        x2="B",
        levels_a=levels_a,
        levels_b=levels_b,
    )

    lm = ols("y ~ A * B", data=df).fit()
    aov = sm.stats.anova_lm(lm, typ=sstype)

    assert model.terms_ == ["A", "B", "A:B", "Residuals"]

    for term in ["A", "B", "A:B"]:
        assert np.isclose(model.sum_sq_[term], aov.loc[term, "sum_sq"], atol=1e-8)
        assert np.isclose(model.df_[term], aov.loc[term, "df"], atol=1e-8)
        assert np.isclose(model.f_stat_[term], aov.loc[term, "F"], atol=1e-8)
        assert np.isclose(model.f_pvalue_[term], aov.loc[term, "PR(>F)"], atol=1e-8)

    assert np.isclose(
        model.sum_sq_["Residuals"], aov.loc["Residual", "sum_sq"], atol=1e-8
    )
    assert np.isclose(model.df_["Residuals"], aov.loc["Residual", "df"], atol=1e-8)
    assert model.f_stat_["Residuals"] is None
    assert model.f_pvalue_["Residuals"] is None
